{% extends "base.html" %}
{% load static %}
{% block main-content %}
	<!-- Content Header (Page header) -->	  
	<div class="content-header">
		<div class="d-flex align-items-center">
			<div class="me-auto">
				<h4 class="page-title">Loan Details</h4>
				<div class="d-inline-block align-items-center">
					<nav>
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a href="{% url 'loans:home' %}"><i class="mdi mdi-home-outline"></i> Home</a></li>
							<li class="breadcrumb-item"><a href="{% url 'loans:loan-disbursement-list' %}">Disbursements</a></li>
							<li class="breadcrumb-item active" aria-current="page">Loan #{{ loan.id }}</li>
						</ol>
					</nav>
				</div>
			</div>
			<div class="mt-3">	
				{% if loan.status == 'ACTIVE' %}
					<a href="{% url 'loans:repayment-create' %}?loan={{ loan.id }}" class="btn btn-success me-2">
						<i class="glyphicon glyphicon-plus"></i> Record Payment
					</a>
				{% endif %}
				<a href="{% url 'loans:loanapplication-detail' loan.loan_application.id %}" class="btn btn-info me-2">
					<i class="glyphicon glyphicon-file"></i> View Application
				</a>
				<a href="{% url 'loans:loan-disbursement-list' %}" class="btn btn-secondary">
					<i class="glyphicon glyphicon-arrow-left"></i> Back to List
				</a>
			</div>
		</div>
	</div>

	<!-- Main content -->
	<section class="content">
		<div class="row">
			<!-- Left Column - Loan Information -->
			<div class="col-12 col-lg-8">
				<!-- Status Card -->
				<div class="box">
					<div class="box-body">
						<div class="row">
							<div class="col-md-8">
								<h3 class="mb-0">Loan #{{ loan.id }}</h3>
								<p class="text-muted mb-0">{{ loan.loan_application.client }}</p>
							</div>
							<div class="col-md-4 text-end">
								<span class="badge badge-lg badge-{% if loan.status == 'ACTIVE' %}success{% elif loan.status == 'CLOSED' %}info{% else %}danger{% endif %}">
									{{ loan.get_status_display }}
								</span>
								{% if is_overdue %}
									<br><small class="text-danger">Overdue by {{ days_until_due|slice:"1:" }} days</small>
								{% elif days_until_due >= 0 %}
									<br><small class="text-muted">{{ days_until_due }} days until due</small>
								{% endif %}
							</div>
						</div>
					</div>
				</div>

				<!-- Loan Details -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Loan Information</h4>
					</div>
					<div class="box-body">
						<div class="row">
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Loan ID:</strong></td>
										<td><strong>#{{ loan.id }}</strong></td>
									</tr>
									<tr>
										<td><strong>Principal Amount:</strong></td>
										<td><strong class="text-primary">${{ principal|floatformat:2 }}</strong></td>
									</tr>
									<tr>
										<td><strong>Interest Amount:</strong></td>
										<td><strong class="text-warning">${{ interest_amount|floatformat:2 }}</strong></td>
									</tr>
									<tr>
										<td><strong>Total Amount:</strong></td>
										<td><strong class="text-success">${{ total_amount|floatformat:2 }}</strong></td>
									</tr>
									<tr>
										<td><strong>Disbursement Date:</strong></td>
										<td>{{ loan.disbursement_date|date:"F d, Y" }}</td>
									</tr>
								</table>
							</div>
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Due Date:</strong></td>
										<td>
											{{ loan.due_date|date:"F d, Y" }}
											{% if is_overdue %}
												<span class="badge badge-danger">Overdue</span>
											{% elif days_until_due <= 30 and days_until_due >= 0 %}
												<span class="badge badge-warning">Due Soon</span>
											{% endif %}
										</td>
									</tr>
									<tr>
										<td><strong>Status:</strong></td>
										<td>
											<span class="badge badge-{% if loan.status == 'ACTIVE' %}success{% elif loan.status == 'CLOSED' %}info{% else %}danger{% endif %}">
												{{ loan.get_status_display }}
											</span>
										</td>
									</tr>
									<tr>
										<td><strong>Outstanding Balance:</strong></td>
										<td><strong class="text-danger">${{ remaining_balance|floatformat:2 }}</strong></td>
									</tr>
									<tr>
										<td><strong>Total Repaid:</strong></td>
										<td><strong class="text-success">${{ total_repaid|floatformat:2 }}</strong></td>
									</tr>
									<tr>
										<td><strong>Created By:</strong></td>
										<td>
											{% if loan.created_by %}
												{{ loan.created_by.get_full_name|default:loan.created_by.username }}
											{% else %}
												N/A
											{% endif %}
										</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Repayment Progress -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Repayment Progress</h4>
					</div>
					<div class="box-body">
						<div class="row">
							<div class="col-md-12">
								<div class="mb-3">
									<div class="d-flex justify-content-between mb-2">
										<span><strong>Repayment Progress</strong></span>
										<span><strong>{{ repayment_percentage|floatformat:1 }}%</strong></span>
									</div>
									<div class="progress" style="height: 25px;">
										<div class="progress-bar {% if repayment_percentage >= 100 %}bg-success{% elif repayment_percentage >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
											 role="progressbar" 
											 style="width: {{ repayment_percentage }}%"
											 aria-valuenow="{{ repayment_percentage }}" 
											 aria-valuemin="0" 
											 aria-valuemax="100">
											{{ repayment_percentage|floatformat:1 }}%
										</div>
									</div>
								</div>
								<div class="row text-center">
									<div class="col-md-3">
										<div class="box box-body bg-primary">
											<h4 class="text-white mb-0">${{ total_amount|floatformat:2 }}</h4>
											<small class="text-white">Total Amount</small>
										</div>
									</div>
									<div class="col-md-3">
										<div class="box box-body bg-success">
											<h4 class="text-white mb-0">${{ total_repaid|floatformat:2 }}</h4>
											<small class="text-white">Total Repaid</small>
										</div>
									</div>
									<div class="col-md-3">
										<div class="box box-body bg-warning">
											<h4 class="text-white mb-0">${{ remaining_balance|floatformat:2 }}</h4>
											<small class="text-white">Outstanding</small>
										</div>
									</div>
									<div class="col-md-3">
										<div class="box box-body bg-info">
											<h4 class="text-white mb-0">{{ payment_count }}</h4>
											<small class="text-white">Payments</small>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Loan Product Details -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Loan Product Details</h4>
						<div class="box-controls pull-right">
							<a href="{% url 'loans:loanproduct-detail' loan.loan_application.loan_product.id %}" class="btn btn-sm btn-info">View Product</a>
						</div>
					</div>
					<div class="box-body">
						<div class="row">
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Product Name:</strong></td>
										<td>
											<a href="{% url 'loans:loanproduct-detail' loan.loan_application.loan_product.id %}">
												{{ loan.loan_application.loan_product.name }}
											</a>
										</td>
									</tr>
									<tr>
										<td><strong>Interest Rate:</strong></td>
										<td><span class="badge badge-info">{{ loan.loan_application.loan_product.interest_rate }}%</span></td>
									</tr>
									<tr>
										<td><strong>Duration:</strong></td>
										<td>{{ loan.loan_application.loan_product.duration_months }} months</td>
									</tr>
								</table>
							</div>
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Repayment Frequency:</strong></td>
										<td><span class="badge badge-success">{{ loan.loan_application.loan_product.get_repayment_frequency_display }}</span></td>
									</tr>
									<tr>
										<td><strong>Application Date:</strong></td>
										<td>{{ loan.loan_application.application_date|date:"F d, Y" }}</td>
									</tr>
									<tr>
										<td><strong>Amount Requested:</strong></td>
										<td>${{ loan.loan_application.amount_requested|floatformat:2 }}</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Client Information -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Client Information</h4>
						<div class="box-controls pull-right">
							<a href="{% url 'clients:client_detail' loan.loan_application.client.id %}" class="btn btn-sm btn-info">View Full Profile</a>
						</div>
					</div>
					<div class="box-body">
						<div class="row">
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Name:</strong></td>
										<td>{{ loan.loan_application.client.first_name }} {{ loan.loan_application.client.last_name|default:"" }}</td>
									</tr>
									<tr>
										<td><strong>Client Type:</strong></td>
										<td><span class="badge badge-primary">{{ loan.loan_application.client.get_client_type_display }}</span></td>
									</tr>
									<tr>
										<td><strong>National ID:</strong></td>
										<td>{{ loan.loan_application.client.national_id }}</td>
									</tr>
								</table>
							</div>
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Phone Number:</strong></td>
										<td>{{ loan.loan_application.client.phone_number }}</td>
									</tr>
									<tr>
										<td><strong>Address:</strong></td>
										<td>{{ loan.loan_application.client.address|default:"N/A" }}</td>
									</tr>
									<tr>
										<td><strong>Active Loans:</strong></td>
										<td><strong>{{ client_active_loans }}</strong></td>
									</tr>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Repayment History -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Repayment History</h4>
						<div class="box-controls pull-right">
							{% if loan.status == 'ACTIVE' %}
								<a href="{% url 'loans:repayment-create' %}?loan={{ loan.id }}" class="btn btn-sm btn-success">Record Payment</a>
							{% endif %}
						</div>
					</div>
					<div class="box-body">
						{% if repayments %}
						<div class="table-responsive">
							<table class="table table-hover">
								<thead>
									<tr>
										<th>#</th>
										<th>Payment Date</th>
										<th>Amount</th>
										<th>Method</th>
										<th>Recorded By</th>
										<th>Balance After</th>
									</tr>
								</thead>
								<tbody>
									{% for repayment in repayments %}
									<tr>
										<td>{{ forloop.counter }}</td>
										<td>{{ repayment.payment_date|date:"M d, Y" }}</td>
										<td><strong class="text-success">${{ repayment.amount|floatformat:2 }}</strong></td>
										<td><span class="badge badge-info">{{ repayment.get_method_display }}</span></td>
										<td>
											{% if repayment.created_by %}
												{{ repayment.created_by.get_full_name|default:repayment.created_by.username }}
											{% else %}
												N/A
											{% endif %}
										</td>
										<td>
											{% if forloop.first %}
												${{ remaining_balance|floatformat:2 }}
											{% else %}
												-
											{% endif %}
										</td>
									</tr>
									{% endfor %}
								</tbody>
								<tfoot>
									<tr>
										<th colspan="2">Total Repaid:</th>
										<th class="text-success">${{ total_repaid|floatformat:2 }}</th>
										<th colspan="2">Payments:</th>
										<th>{{ payment_count }}</th>
									</tr>
									{% if payment_count > 0 %}
									<tr>
										<th colspan="2">Average Payment:</th>
										<th class="text-info">${{ average_payment|floatformat:2 }}</th>
										<th colspan="2">Outstanding Balance:</th>
										<th class="text-danger">${{ remaining_balance|floatformat:2 }}</th>
									</tr>
									{% endif %}
								</tfoot>
							</table>
						</div>
						{% else %}
						<div class="alert alert-info">
							<i class="fa fa-info-circle"></i> No payments have been recorded for this loan yet.
							{% if loan.status == 'ACTIVE' %}
								<a href="{% url 'loans:repayment-create' %}?loan={{ loan.id }}" class="btn btn-sm btn-success ml-2">Record First Payment</a>
							{% endif %}
						</div>
						{% endif %}
					</div>
				</div>
			</div>

			<!-- Right Column - Summary & Actions -->
			<div class="col-12 col-lg-4">
				<!-- Loan Summary -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Loan Summary</h4>
					</div>
					<div class="box-body">
						<div class="list-group">
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Principal</span>
								<strong>${{ principal|floatformat:2 }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Interest</span>
								<strong class="text-warning">${{ interest_amount|floatformat:2 }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Amount</span>
								<strong class="text-primary">${{ total_amount|floatformat:2 }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Repaid</span>
								<strong class="text-success">${{ total_repaid|floatformat:2 }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Outstanding</span>
								<strong class="text-danger">${{ remaining_balance|floatformat:2 }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Payment Count</span>
								<strong>{{ payment_count }}</strong>
							</div>
							{% if payment_count > 0 %}
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Average Payment</span>
								<strong class="text-info">${{ average_payment|floatformat:2 }}</strong>
							</div>
							{% endif %}
						</div>
					</div>
				</div>

				<!-- Quick Actions -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Quick Actions</h4>
					</div>
					<div class="box-body">
						{% if loan.status == 'ACTIVE' %}
							<a href="{% url 'loans:repayment-create' %}?loan={{ loan.id }}" class="btn btn-success btn-block mb-2">
								<i class="glyphicon glyphicon-plus"></i> Record Payment
							</a>
						{% endif %}
						
						<a href="{% url 'loans:loanapplication-detail' loan.loan_application.id %}" class="btn btn-info btn-block mb-2">
							<i class="glyphicon glyphicon-file"></i> View Application
						</a>
						
						<a href="{% url 'clients:client_detail' loan.loan_application.client.id %}" class="btn btn-primary btn-block mb-2">
							<i class="glyphicon glyphicon-user"></i> View Client Profile
						</a>
						
						<a href="{% url 'loans:loanproduct-detail' loan.loan_application.loan_product.id %}" class="btn btn-warning btn-block">
							<i class="glyphicon glyphicon-list"></i> View Loan Product
						</a>
					</div>
				</div>

				<!-- Payment Statistics -->
				{% if payment_count > 0 %}
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Payment Statistics</h4>
					</div>
					<div class="box-body">
						<div class="list-group">
							<div class="list-group-item">
								<strong>First Payment:</strong><br>
								<small class="text-muted">{{ first_payment_date|date:"F d, Y" }}</small>
							</div>
							<div class="list-group-item">
								<strong>Last Payment:</strong><br>
								<small class="text-muted">{{ last_payment_date|date:"F d, Y" }}</small>
							</div>
							<div class="list-group-item">
								<strong>Total Payments:</strong><br>
								<small class="text-muted">{{ payment_count }} payment{{ payment_count|pluralize }}</small>
							</div>
							<div class="list-group-item">
								<strong>Average Payment:</strong><br>
								<small class="text-muted">${{ average_payment|floatformat:2 }}</small>
							</div>
						</div>
					</div>
				</div>
				{% endif %}

				<!-- Client's Other Loans -->
				{% if client_other_loans %}
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Client's Other Loans</h4>
					</div>
					<div class="box-body">
						<div class="list-group">
							{% for other_loan in client_other_loans %}
							<a href="{% url 'loans:loan-detail' other_loan.id %}" class="list-group-item">
								<div class="d-flex justify-content-between">
									<div>
										<strong>Loan #{{ other_loan.id }}</strong>
										<br>
										<small class="text-muted">${{ other_loan.disbursed_amount|floatformat:2 }}</small>
									</div>
									<div>
										<span class="badge badge-{% if other_loan.status == 'ACTIVE' %}success{% elif other_loan.status == 'CLOSED' %}info{% else %}danger{% endif %}">
											{{ other_loan.get_status_display }}
										</span>
										<br>
										<small class="text-muted">${{ other_loan.balance|floatformat:2 }} balance</small>
									</div>
								</div>
							</a>
							{% endfor %}
						</div>
					</div>
				</div>
				{% endif %}

				<!-- Loan Timeline -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Loan Timeline</h4>
					</div>
					<div class="box-body">
						<div class="timeline">
							<div>
								<i class="fas fa-file-alt bg-blue"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ loan.loan_application.application_date|date:"M d, Y" }}</span>
									<h3 class="timeline-header">Application Submitted</h3>
								</div>
							</div>

							<div>
								<i class="fas fa-check bg-green"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ loan.loan_application.updated_at|date:"M d, Y" }}</span>
									<h3 class="timeline-header">Application Approved</h3>
								</div>
							</div>

							<div>
								<i class="fas fa-money-bill-wave bg-green"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ loan.disbursement_date|date:"M d, Y" }}</span>
									<h3 class="timeline-header">Loan Disbursed</h3>
									<div class="timeline-body">
										Amount: ${{ loan.disbursed_amount|floatformat:2 }}
									</div>
								</div>
							</div>

							{% if first_payment_date %}
							<div>
								<i class="fas fa-arrow-down bg-info"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ first_payment_date|date:"M d, Y" }}</span>
									<h3 class="timeline-header">First Payment</h3>
									<div class="timeline-body">
										${{ repayments.last.amount|floatformat:2 }}
									</div>
								</div>
							</div>
							{% endif %}

							{% if loan.status == 'CLOSED' %}
							<div>
								<i class="fas fa-check-circle bg-success"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ loan.updated_at|date:"M d, Y" }}</span>
									<h3 class="timeline-header">Loan Closed</h3>
									<div class="timeline-body">
										Fully repaid
									</div>
								</div>
							</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- /.content -->
{% endblock main-content %}

