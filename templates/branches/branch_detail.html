{% extends "base.html" %}
{% load static %}
{% block main-content %}
	<!-- Content Header (Page header) -->	  
	<div class="content-header">
		<div class="d-flex align-items-center">
			<div class="me-auto">
				<h4 class="page-title">Branch Details</h4>
				<div class="d-inline-block align-items-center">
					<nav>
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a href="{% url 'loans:home' %}"><i class="mdi mdi-home-outline"></i> Home</a></li>
							<li class="breadcrumb-item"><a href="{% url 'branches:branch_list' %}">Branches</a></li>
							<li class="breadcrumb-item active" aria-current="page">{{ branch.name }}</li>
						</ol>
					</nav>
				</div>
			</div>
			<div class="mt-3">	
				<a href="{% url 'branches:branch_edit' branch.id %}" class="btn btn-warning me-2">
					<i class="glyphicon glyphicon-edit"></i> Edit Branch
				</a>
				<a href="{% url 'branches:branch_list' %}" class="btn btn-secondary">
					<i class="glyphicon glyphicon-arrow-left"></i> Back to List
				</a>
			</div>
		</div>
	</div>

	<!-- Main content -->
	<section class="content">
		<div class="row">
			<!-- Left Column - Branch Information -->
			<div class="col-12 col-lg-8">
				<!-- Branch Profile Card -->
				<div class="box">
					<div class="box-body">
						<div class="row">
							<div class="col-md-8">
								<h3 class="mb-0">{{ branch.name }}</h3>
								<p class="text-muted mb-0">{{ branch.location }}</p>
							</div>
							<div class="col-md-4 text-end">
								{% if has_manager %}
									<small class="text-muted">Managed by</small><br>
									<strong>{{ manager.get_full_name|default:manager.username }}</strong>
								{% else %}
									<span class="badge badge-warning">No Manager Assigned</span>
								{% endif %}
							</div>
						</div>
					</div>
				</div>

				<!-- Branch Details -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Branch Information</h4>
					</div>
					<div class="box-body">
						<div class="row">
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Branch Name:</strong></td>
										<td>{{ branch.name }}</td>
									</tr>
									<tr>
										<td><strong>Location:</strong></td>
										<td>{{ branch.location }}</td>
									</tr>
									<tr>
										<td><strong>Phone:</strong></td>
										<td>{{ branch.phone|default:"N/A" }}</td>
									</tr>
								</table>
							</div>
							<div class="col-md-6">
								<table class="table table-borderless">
									<tr>
										<td><strong>Manager:</strong></td>
										<td>
											{% if has_manager %}
												{{ manager.get_full_name|default:manager.username }}
												<span class="badge badge-info">{{ manager.get_role_display }}</span>
											{% else %}
												<span class="text-muted">Not assigned</span>
											{% endif %}
										</td>
									</tr>
									<tr>
										<td><strong>Created By:</strong></td>
										<td>
											{% if branch.created_by %}
												{{ branch.created_by.get_full_name|default:branch.created_by.username }}
											{% else %}
												N/A
											{% endif %}
										</td>
									</tr>
									<tr>
										<td><strong>Created At:</strong></td>
										<td>{{ branch.created_at|date:"F d, Y" }}</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Statistics Cards -->
				<div class="row">
					<div class="col-md-3 col-6">
						<div class="box box-body bg-primary">
							<h4 class="text-white">Total Clients</h4>
							<h2 class="text-white mb-0">{{ total_clients }}</h2>
						</div>
					</div>
					<div class="col-md-3 col-6">
						<div class="box box-body bg-info">
							<h4 class="text-white">Total Loans</h4>
							<h2 class="text-white mb-0">{{ total_loans }}</h2>
						</div>
					</div>
					<div class="col-md-3 col-6">
						<div class="box box-body bg-success">
							<h4 class="text-white">Total Disbursed</h4>
							<h2 class="text-white mb-0">${{ total_disbursed|floatformat:0|default:"0" }}</h2>
						</div>
					</div>
					<div class="col-md-3 col-6">
						<div class="box box-body bg-warning">
							<h4 class="text-white">Outstanding</h4>
							<h2 class="text-white mb-0">${{ total_outstanding|floatformat:0|default:"0" }}</h2>
						</div>
					</div>
				</div>

				<!-- Clients Section -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Clients</h4>
						<div class="box-controls pull-right">
							<a href="{% url 'clients:client_list' %}?branch={{ branch.id }}" class="btn btn-sm btn-primary">View All</a>
						</div>
					</div>
					<div class="box-body">
						<div class="row mb-3">
							<div class="col-md-6">
								<div class="text-center">
									<h3 class="text-success">{{ active_clients }}</h3>
									<p class="text-muted">Active Clients</p>
								</div>
							</div>
							<div class="col-md-6">
								<div class="text-center">
									<h3 class="text-secondary">{{ inactive_clients }}</h3>
									<p class="text-muted">Inactive Clients</p>
								</div>
							</div>
						</div>
						<div class="table-responsive">
							<table class="table table-hover">
								<thead>
									<tr>
										<th>Name</th>
										<th>Type</th>
										<th>Phone</th>
										<th>Status</th>
										<th>Date Joined</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									{% for client in recent_clients %}
									<tr>
										<td>{{ client.first_name }} {{ client.last_name|default:"" }}</td>
										<td><span class="badge badge-primary">{{ client.get_client_type_display }}</span></td>
										<td>{{ client.phone_number }}</td>
										<td>
											<span class="badge badge-{% if client.status == 'ACTIVE' %}success{% else %}secondary{% endif %}">
												{{ client.get_status_display }}
											</span>
										</td>
										<td>{{ client.date_joined|date:"M d, Y" }}</td>
										<td>
											<a href="{% url 'clients:client_detail' client.id %}" class="btn btn-xs btn-info">
												<i class="glyphicon glyphicon-eye-open"></i> View
											</a>
										</td>
									</tr>
									{% empty %}
									<tr>
										<td colspan="6" class="text-center text-muted">No clients found</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Loan Applications Section -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Loan Applications</h4>
						<div class="box-controls pull-right">
							<a href="{% url 'loans:loanapplication-list' %}?branch={{ branch.id }}" class="btn btn-sm btn-primary">View All</a>
						</div>
					</div>
					<div class="box-body">
						<div class="row mb-3">
							<div class="col-md-3">
								<div class="text-center">
									<h3 class="text-warning">{{ pending_applications }}</h3>
									<p class="text-muted">Pending</p>
								</div>
							</div>
							<div class="col-md-3">
								<div class="text-center">
									<h3 class="text-info">{{ approved_applications }}</h3>
									<p class="text-muted">Approved</p>
								</div>
							</div>
							<div class="col-md-3">
								<div class="text-center">
									<h3 class="text-danger">{{ rejected_applications }}</h3>
									<p class="text-muted">Rejected</p>
								</div>
							</div>
							<div class="col-md-3">
								<div class="text-center">
									<h3 class="text-success">{{ disbursed_applications }}</h3>
									<p class="text-muted">Disbursed</p>
								</div>
							</div>
						</div>
						<div class="table-responsive">
							<table class="table table-hover">
								<thead>
									<tr>
										<th>Application #</th>
										<th>Client</th>
										<th>Product</th>
										<th>Amount</th>
										<th>Date</th>
										<th>Status</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									{% for application in recent_applications %}
									<tr>
										<td>#{{ application.id }}</td>
										<td>{{ application.client }}</td>
										<td>{{ application.loan_product.name }}</td>
										<td>${{ application.amount_requested|floatformat:2 }}</td>
										<td>{{ application.application_date|date:"M d, Y" }}</td>
										<td>
											<span class="badge badge-{% if application.status == 'APPROVED' %}success{% elif application.status == 'PENDING' %}warning{% elif application.status == 'REJECTED' %}danger{% else %}info{% endif %}">
												{{ application.get_status_display }}
											</span>
										</td>
										<td>
											<a href="{% url 'loans:loanapplication-detail' application.id %}" class="btn btn-xs btn-info">
												<i class="glyphicon glyphicon-eye-open"></i> View
											</a>
										</td>
									</tr>
									{% empty %}
									<tr>
										<td colspan="7" class="text-center text-muted">No applications found</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Loans Section -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Loans</h4>
						<div class="box-controls pull-right">
							<a href="{% url 'loans:loan-disbursement-list' %}?branch={{ branch.id }}" class="btn btn-sm btn-primary">View All</a>
						</div>
					</div>
					<div class="box-body">
						<div class="row mb-3">
							<div class="col-md-4">
								<div class="text-center">
									<h3 class="text-success">{{ active_loans }}</h3>
									<p class="text-muted">Active</p>
								</div>
							</div>
							<div class="col-md-4">
								<div class="text-center">
									<h3 class="text-info">{{ closed_loans }}</h3>
									<p class="text-muted">Closed</p>
								</div>
							</div>
							<div class="col-md-4">
								<div class="text-center">
									<h3 class="text-danger">{{ defaulted_loans }}</h3>
									<p class="text-muted">Defaulted</p>
								</div>
							</div>
						</div>
						<div class="table-responsive">
							<table class="table table-hover">
								<thead>
									<tr>
										<th>Loan #</th>
										<th>Client</th>
										<th>Disbursed</th>
										<th>Balance</th>
										<th>Due Date</th>
										<th>Status</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									{% for loan in recent_loans %}
									<tr>
										<td>#{{ loan.id }}</td>
										<td>{{ loan.loan_application.client }}</td>
										<td>${{ loan.disbursed_amount|floatformat:2 }}</td>
										<td><strong class="text-{% if loan.balance > 0 %}danger{% else %}success{% endif %}">${{ loan.balance|floatformat:2 }}</strong></td>
										<td>{{ loan.due_date|date:"M d, Y" }}</td>
										<td>
											<span class="badge badge-{% if loan.status == 'ACTIVE' %}success{% elif loan.status == 'CLOSED' %}info{% else %}danger{% endif %}">
												{{ loan.get_status_display }}
											</span>
										</td>
										<td>
											<a href="{% url 'loans:loan-detail' loan.id %}" class="btn btn-xs btn-info">
												<i class="glyphicon glyphicon-eye-open"></i> View
											</a>
										</td>
									</tr>
									{% empty %}
									<tr>
										<td colspan="7" class="text-center text-muted">No loans found</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Recent Repayments -->
				{% if recent_repayments %}
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Recent Repayments</h4>
						<div class="box-controls pull-right">
							<a href="{% url 'loans:repayment-list' %}?branch={{ branch.id }}" class="btn btn-sm btn-primary">View All</a>
						</div>
					</div>
					<div class="box-body">
						<div class="table-responsive">
							<table class="table table-hover">
								<thead>
									<tr>
										<th>Date</th>
										<th>Loan #</th>
										<th>Client</th>
										<th>Amount</th>
										<th>Method</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									{% for repayment in recent_repayments %}
									<tr>
										<td>{{ repayment.payment_date|date:"M d, Y" }}</td>
										<td>#{{ repayment.loan.id }}</td>
										<td>{{ repayment.loan.loan_application.client }}</td>
										<td><strong class="text-success">${{ repayment.amount|floatformat:2 }}</strong></td>
										<td><span class="badge badge-info">{{ repayment.get_method_display }}</span></td>
										<td>
											<a href="{% url 'loans:repayment-detail' repayment.id %}" class="btn btn-xs btn-info">
												<i class="glyphicon glyphicon-eye-open"></i> View
											</a>
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				{% endif %}
			</div>

			<!-- Right Column - Summary & Actions -->
			<div class="col-12 col-lg-4">
				<!-- Branch Summary -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Branch Summary</h4>
					</div>
					<div class="box-body">
						<div class="list-group">
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Clients</span>
								<strong>{{ total_clients }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Active Clients</span>
								<strong class="text-success">{{ active_clients }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Applications</span>
								<strong>{{ total_applications }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Loans</span>
								<strong>{{ total_loans }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Active Loans</span>
								<strong class="text-success">{{ active_loans }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Requested</span>
								<strong>${{ total_requested|floatformat:2|default:"0.00" }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Disbursed</span>
								<strong class="text-primary">${{ total_disbursed|floatformat:2|default:"0.00" }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Total Repaid</span>
								<strong class="text-success">${{ total_repaid|floatformat:2|default:"0.00" }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Outstanding</span>
								<strong class="text-danger">${{ total_outstanding|floatformat:2|default:"0.00" }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between align-items-center">
								<span>Staff Members</span>
								<strong>{{ total_staff }}</strong>
							</div>
						</div>
					</div>
				</div>

				<!-- Quick Actions -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Quick Actions</h4>
					</div>
					<div class="box-body">
						<a href="{% url 'clients:client_create' %}" class="btn btn-success btn-block mb-2">
							<i class="glyphicon glyphicon-plus"></i> New Client
						</a>
						
						<a href="{% url 'loans:loanapplication-create' %}" class="btn btn-primary btn-block mb-2">
							<i class="glyphicon glyphicon-plus"></i> New Application
						</a>
						
						<a href="{% url 'branches:branch_edit' branch.id %}" class="btn btn-warning btn-block mb-2">
							<i class="glyphicon glyphicon-edit"></i> Edit Branch
						</a>
						
						<a href="{% url 'clients:client_list' %}?branch={{ branch.id }}" class="btn btn-info btn-block mb-2">
							<i class="glyphicon glyphicon-list"></i> View All Clients
						</a>
						
						<a href="{% url 'loans:loanapplication-list' %}?branch={{ branch.id }}" class="btn btn-primary btn-block">
							<i class="glyphicon glyphicon-list"></i> View All Applications
						</a>
					</div>
				</div>

				<!-- Staff Members -->
				{% if staff_members %}
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Staff Members</h4>
					</div>
					<div class="box-body">
						<div class="list-group">
							{% for staff in staff_members %}
							<div class="list-group-item">
								<div class="d-flex justify-content-between align-items-center">
									<div>
										<strong>{{ staff.get_full_name|default:staff.username }}</strong>
										<br>
										<small class="text-muted">{{ staff.get_role_display }}</small>
									</div>
									{% if staff.id == branch.manager.id %}
										<span class="badge badge-warning">Manager</span>
									{% endif %}
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
				</div>
				{% endif %}

				<!-- Repayment Progress -->
				{% if total_loans > 0 %}
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Repayment Progress</h4>
					</div>
					<div class="box-body">
						<div class="mb-3">
							<div class="d-flex justify-content-between mb-2">
								<span><strong>Repayment Progress</strong></span>
								<span><strong>{{ repayment_percentage|floatformat:1 }}%</strong></span>
							</div>
							<div class="progress" style="height: 25px;">
								<div class="progress-bar {% if repayment_percentage >= 100 %}bg-success{% elif repayment_percentage >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
									 role="progressbar" 
									 style="width: {{ repayment_percentage }}%"
									 aria-valuenow="{{ repayment_percentage }}" 
									 aria-valuemin="0" 
									 aria-valuemax="100">
									{{ repayment_percentage|floatformat:1 }}%
								</div>
							</div>
						</div>
						<div class="list-group">
							<div class="list-group-item d-flex justify-content-between">
								<span>Total Loan Amount</span>
								<strong>${{ total_loan_amount|floatformat:2 }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between">
								<span>Total Repaid</span>
								<strong class="text-success">${{ total_repaid|floatformat:2 }}</strong>
							</div>
							<div class="list-group-item d-flex justify-content-between">
								<span>Outstanding</span>
								<strong class="text-danger">${{ total_outstanding|floatformat:2 }}</strong>
							</div>
						</div>
					</div>
				</div>
				{% endif %}

				<!-- Branch Timeline -->
				<div class="box">
					<div class="box-header with-border">
						<h4 class="box-title">Branch Timeline</h4>
					</div>
					<div class="box-body">
						<div class="timeline">
							<div>
								<i class="fas fa-building bg-blue"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ branch.created_at|date:"M d, Y" }}</span>
									<h3 class="timeline-header">Branch Created</h3>
									<div class="timeline-body">
										Branch established on {{ branch.created_at|date:"F d, Y" }}
										{% if branch.created_by %}
											<br>Created by {{ branch.created_by.get_full_name|default:branch.created_by.username }}
										{% endif %}
									</div>
								</div>
							</div>

							{% if recent_clients %}
							<div>
								<i class="fas fa-user-plus bg-green"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ recent_clients.0.date_joined|date:"M d, Y" }}</span>
									<h3 class="timeline-header">First Client</h3>
									<div class="timeline-body">
										{{ recent_clients.0.first_name }} {{ recent_clients.0.last_name|default:"" }}
									</div>
								</div>
							</div>
							{% endif %}

							{% if recent_applications %}
							<div>
								<i class="fas fa-file-alt bg-info"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ recent_applications.0.application_date|date:"M d, Y" }}</span>
									<h3 class="timeline-header">First Application</h3>
									<div class="timeline-body">
										${{ recent_applications.0.amount_requested|floatformat:2 }}
									</div>
								</div>
							</div>
							{% endif %}

							{% if recent_loans %}
							<div>
								<i class="fas fa-money-bill-wave bg-success"></i>
								<div class="timeline-item">
									<span class="time"><i class="fas fa-clock"></i> {{ recent_loans.0.disbursement_date|date:"M d, Y" }}</span>
									<h3 class="timeline-header">First Loan Disbursed</h3>
									<div class="timeline-body">
										${{ recent_loans.0.disbursed_amount|floatformat:2 }}
									</div>
								</div>
							</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- /.content -->
{% endblock main-content %}

